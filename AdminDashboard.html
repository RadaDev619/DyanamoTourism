<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TravelVibe Admin Dashboard</title>

    <!-- External Libraries -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* CSS Styles */
      :root {
        --primary-blue: #1a73e8;
        --dark-blue: #0d47a1;
        --light-blue: #e3f2fd;
        --background-color: #f5f7fa;
        --text-dark: #333;
        --text-light: #757575;
        --border-color: #e0e0e0;
        --white: #ffffff;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
      }
      body {
        background-color: var(--background-color);
        display: flex;
        color: var(--text-dark);
      }

      .sidebar {
        width: 250px;
        background-color: var(--white);
        padding: 20px;
        height: 100vh;
        border-right: 1px solid var(--border-color);
        position: fixed;
        overflow-y: auto;
      }
      .nav-item {
        padding: 15px;
        margin: 5px 0;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .nav-item:hover,
      .nav-item.active {
        background-color: var(--primary-blue);
        color: var(--white);
      }

      .main-content {
        flex-grow: 1;
        padding: 24px;
        height: 100vh;
        overflow-y: auto;
        margin-left: 250px;
      }
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .top-bar-left h2 {
        font-size: 24px;
        font-weight: 600;
      }
      .top-bar-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      /* Notifications */
      .notification {
        position: relative;
        cursor: pointer;
      }
      .notification-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: var(--danger);
        color: var(--white);
        border-radius: 50%;
        min-width: 18px;
        height: 18px;
        padding: 0 5px;
        font-size: 12px;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .notification-panel {
        position: absolute;
        top: 40px;
        right: 0;
        width: 360px;
        background: var(--white);
        border-radius: 8px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: none;
        z-index: 1000;
      }
      .notification-panel.active {
        display: block;
      }
      .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
      }
      .notification-list {
        max-height: 400px;
        overflow-y: auto;
      }
      .notification-item {
        display: flex;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
      }
      .notification-item:last-child {
        border-bottom: 0;
      }
      .notification-item.unread {
        background-color: var(--light-blue);
      }
      .notification-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
      }
      .notification-message {
        font-size: 13px;
        color: var(--text-light);
      }
      .notification-time {
        font-size: 12px;
        color: var(--text-light);
        margin-top: 6px;
      }
      .notification-icon {
        font-size: 20px;
        color: var(--primary-blue);
      }
      .notification-actions {
        padding: 12px;
        border-top: 1px solid var(--border-color);
      }

      /* NEW: User Profile Dropdown Styles */
      .user-profile-container {
        position: relative;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background-color 0.3s;
      }

      .user-profile:hover {
        background-color: var(--light-blue);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--dark-blue);
        color: var(--white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }
      .user-name {
        font-weight: 600;
      }
      .user-role {
        font-size: 14px;
        color: var(--text-light);
      }

      .profile-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        width: 200px;
        background: var(--white);
        border-radius: 8px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: none; /* Initially hidden */
        z-index: 1001;
        border: 1px solid var(--border-color);
      }

      .profile-dropdown.active {
        display: block; /* Show when active */
      }

      .profile-dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 14px;
        border-bottom: 1px solid var(--border-color);
      }
      .profile-dropdown-item:last-child {
        border-bottom: none;
      }

      .profile-dropdown-item:hover {
        background-color: var(--light-blue);
      }

      .profile-dropdown-item i {
        width: 16px;
        text-align: center;
        color: var(--text-light);
      }
      /* END: User Profile Dropdown Styles */

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
      }
      .stat-card {
        background: var(--white);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        position: relative;
      }
      .stat-icon {
        font-size: 24px;
        color: var(--primary-blue);
        margin-bottom: 12px;
      }
      .stat-title {
        color: var(--text-light);
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .stat-value {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .stat-change.positive {
        color: var(--success);
      }
      .stat-note {
        font-size: 12px;
        color: var(--text-light);
      }

      .inline-selects {
        display: flex;
        gap: 6px;
      }
      .inline-selects select {
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 4px 6px;
        font-size: 12px;
        background: #fff;
        color: var(--text-dark);
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
      }
      .chart-card {
        background: var(--white);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      .chart-card h3 {
        margin-bottom: 16px;
        font-weight: 600;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .section-header h2 {
        font-size: 20px;
        font-weight: 600;
      }
      .table-container {
        background: var(--white);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }
      th {
        font-weight: 600;
        color: var(--text-light);
        font-size: 14px;
      }
      td {
        font-size: 14px;
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      .status {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: capitalize;
      }
      .status.confirmed {
        background-color: #e8f5e9;
        color: #388e3c;
      }
      .status.pending {
        background-color: #fff3e0;
        color: #f57c00;
      }
      .status.cancelled,
      .status.rejected {
        background-color: #ffebee;
        color: #d32f2f;
      }
      .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-light);
        font-size: 16px;
        padding: 5px;
      }
      .action-btn:hover {
        color: var(--primary-blue);
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        background-color: var(--primary-blue);
        color: var(--white);
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn:hover {
        background-color: var(--dark-blue);
      }
      .btn-secondary {
        background-color: #e0e0e0;
        color: var(--text-dark);
      }
      .btn-secondary:hover {
        background-color: #bdbdbd;
      }
      .btn-danger {
        background-color: var(--danger);
      }
      .btn-danger:hover {
        background-color: #c62828;
      }
      .btn-success {
        background-color: var(--success);
      }
      .btn-success:hover {
        background-color: #1e7e34;
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: var(--white);
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
      }
      .modal-header h3 {
        font-size: 18px;
      }
      .modal-header .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
      }
      .modal-body {
        padding: 24px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 16px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
      }
      .form-group label {
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
      }

      .package-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
      }
      .package-card {
        background: var(--white);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .package-image img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      .package-content {
        padding: 16px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .package-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .package-location {
        color: var(--text-light);
        margin-bottom: 12px;
        font-size: 14px;
      }
      .package-price {
        font-size: 20px;
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 12px;
      }
      .package-meta {
        display: flex;
        justify-content: space-between;
        color: var(--text-light);
        font-size: 13px;
        margin-bottom: 16px;
      }
      .package-actions {
        display: flex;
        gap: 10px;
        margin-top: auto;
      }
      .package-actions .btn {
        flex-grow: 1;
        padding: 8px;
      }

      .image-upload label {
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        display: block;
      }
      .image-upload-preview {
        width: 100%;
        height: 200px;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        margin-bottom: 16px;
      }
      .image-upload-placeholder {
        text-align: center;
        color: var(--text-light);
      }
      .image-upload-placeholder i {
        font-size: 32px;
        margin-bottom: 8px;
      }
      .image-upload-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .calculator-container {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 24px;
      }
      .calculator-results .result-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
      }
      .calculator-results .result-item.total {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary-blue);
      }

      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--success);
        color: var(--white);
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
      }
      .toast.show {
        opacity: 1;
        bottom: 30px;
      }
      .toast.error {
        background-color: var(--danger);
      }

      .content-section {
        display: none;
      }
      .content-section.active {
        display: block;
      }

      .price-details-header {
        display: grid;
        grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr 1.5fr 1fr;
        gap: 10px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 5px;
        padding: 0 10px;
      }
      .price-detail-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1.5fr 1.5fr 1.5fr 1.5fr 1fr;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }
      .price-detail-row input,
      .price-detail-row select {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
      }
      .price-detail-row .btn-danger {
        padding: 8px 12px;
      }

      .booking-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      .booking-detail-group h4 {
        font-size: 16px;
        color: var(--primary-blue);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
      }
      .booking-detail-item {
        display: flex;
        flex-direction: column;
        margin-bottom: 12px;
      }
      .booking-detail-item .label {
        font-size: 12px;
        color: var(--text-light);
        margin-bottom: 4px;
        text-transform: uppercase;
      }
      .booking-detail-item .value {
        font-size: 14px;
        font-weight: 500;
      }
      .booking-detail-item .value.large {
        font-size: 18px;
        font-weight: 600;
      }

      /* Profile modal specific styles */
      #profile-modal .modal-content {
        max-width: 500px;
      }

      #profile-modal .form-group {
        margin-bottom: 16px;
      }

      #profile-modal .form-group label {
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        display: block;
      }

      #profile-modal .form-group input {
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        width: 100%;
      }

      #profile-modal .form-group input[readonly] {
        background-color: var(--background-color);
        color: var(--text-light);
      }

      /* Gallery Styles */
      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }
      .gallery-item {
        background: var(--white);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        position: relative;
        aspect-ratio: 1;
      }
      .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .gallery-item-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .gallery-item:hover .gallery-item-actions {
        opacity: 1;
      }
      .gallery-item-action {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
      }
      .gallery-item-action:hover {
        background: rgba(0, 0, 0, 0.9);
      }
      .gallery-upload-area {
        background: var(--white);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 24px;
        margin-bottom: 24px;
      }
      .gallery-upload-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }
      .gallery-upload-item {
        position: relative;
        aspect-ratio: 1;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .gallery-upload-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .gallery-upload-placeholder {
        text-align: center;
        color: var(--text-light);
      }
      .gallery-upload-placeholder i {
        font-size: 32px;
        margin-bottom: 8px;
      }
      .gallery-upload-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
      }

      /* Events Section Styles */
      .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
      }
      .event-card {
        background: var(--white);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .event-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      .event-image {
        width: 100%;
        height: 200px;
        overflow: hidden;
      }
      .event-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }
      .event-card:hover .event-image img {
        transform: scale(1.05);
      }
      .event-content {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .event-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-dark);
      }
      .event-location {
        color: var(--text-light);
        margin-bottom: 12px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .event-description {
        color: var(--text-light);
        margin-bottom: 16px;
        font-size: 14px;
        line-height: 1.5;
        flex-grow: 1;
      }
      .event-meta {
        display: flex;
        justify-content: space-between;
        color: var(--text-light);
        font-size: 13px;
        margin-bottom: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }
      .event-date {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
      }
      .event-price {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 16px;
      }
      .event-actions {
        display: flex;
        gap: 10px;
        margin-top: auto;
      }
      .event-actions .btn {
        flex-grow: 1;
        padding: 8px;
      }
      .event-status {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: capitalize;
      }
      .event-status.upcoming {
        background-color: #e8f5e9;
        color: #388e3c;
      }
      .event-status.ongoing {
        background-color: #fff3e0;
        color: #f57c00;
      }
      .event-status.completed {
        background-color: #f5f5f5;
        color: #757575;
      }
      .event-status.cancelled {
        background-color: #ffebee;
        color: #d32f2f;
      }

      /* Event Modal Styles */
      #event-modal .modal-content {
        max-width: 700px;
      }
      .event-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 16px;
      }
      .event-form-full {
        grid-column: 1 / -1;
      }

      /* NEW: Testimonial specific styles */
      .testimonial-avatar-sm {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--light-blue);
      }

      .rating-stars {
        color: var(--warning);
      }

      /* NEW: Testimonial avatar upload styles */
      .testimonial-avatar-upload {
        margin-bottom: 16px;
      }

      .testimonial-avatar-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 2px dashed var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        margin-bottom: 10px;
        background-color: var(--light-blue);
      }

      .testimonial-avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .testimonial-avatar-placeholder {
        text-align: center;
        color: var(--text-light);
      }

      .testimonial-avatar-placeholder i {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .testimonial-avatar-input {
        display: none;
      }

      .testimonial-avatar-upload-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .testimonial-avatar-upload-actions .btn {
        flex: 1;
        padding: 8px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h1 style="padding: 15px; font-size: 24px; color: var(--dark-blue)">
        TravelVibe
      </h1>
      <div class="nav-item active" data-section="dashboard">
        <i class="fas fa-chart-pie"></i><span>Dashboard</span>
      </div>
      <div class="nav-item" data-section="packages">
        <i class="fas fa-suitcase-rolling"></i><span>Packages</span>
      </div>
      <div class="nav-item" data-section="bookings">
        <i class="fas fa-book-open"></i><span>Bookings</span>
      </div>
      <div class="nav-item" data-section="events">
        <i class="fas fa-calendar-alt"></i><span>Events</span>
      </div>
      <div class="nav-item" data-section="testimonials">
        <i class="fas fa-star"></i><span>Testimonials</span>
      </div>
      <!-- NEW: FAQ Nav Item -->
      <div class="nav-item" data-section="faq">
        <i class="fas fa-question-circle"></i><span>FAQ</span>
      </div>
      <!-- <div class="nav-item" data-section="gallery">
        <i class="fas fa-images"></i><span>Gallery</span>
      </div> -->
    </div>

    <div class="main-content">
      <div class="top-bar">
        <div class="top-bar-left">
          <h2>Dashboard Overview</h2>
        </div>
        <div class="top-bar-right">
          <!-- NOTIFICATION: dynamic -->
          <div
            class="notification"
            id="notification-toggle"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <i class="fas fa-bell fa-lg"></i>
            <div class="notification-badge" id="notification-badge">0</div>
            <div class="notification-panel" id="notification-panel">
              <div class="notification-header">
                <h4>Pending Bookings</h4>
                <button class="btn btn-sm" id="clear-notifications">
                  Mark All as Read
                </button>
              </div>
              <div class="notification-list" id="notification-list"></div>
              <div class="notification-actions">
                <button class="btn btn-sm" id="view-all-notifications">
                  View All
                </button>
              </div>
            </div>
          </div>
          <!-- MODIFIED: User Profile with Dropdown -->
          <div class="user-profile-container">
            <div class="user-profile" id="profile-menu-trigger">
              <!-- MODIFIED: Added IDs for dynamic content -->
              <div class="user-avatar" id="admin-user-avatar">AD</div>
              <div class="user-info">
                <div class="user-name" id="admin-user-name">Admin User</div>
                <div class="user-role" id="admin-user-role">Administrator</div>
              </div>
              <i
                class="fas fa-chevron-down"
                style="
                  margin-left: 8px;
                  font-size: 12px;
                  color: var(--text-light);
                "
              ></i>
            </div>
            <div class="profile-dropdown" id="profile-dropdown">
              <div class="profile-dropdown-item" id="edit-profile-btn">
                <i class="fas fa-user-edit"></i>
                <span>Edit Profile</span>
              </div>
              <div class="profile-dropdown-item" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div id="dashboard-section" class="content-section active">
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-suitcase"></i>
            </div>
            <div class="stat-title">Total Packages</div>
            <div class="stat-value" id="total-packages">0</div>
            <div class="stat-note" id="packages-note"></div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-book"></i>
            </div>
            <div class="stat-title">Total Confirmed Bookings</div>
            <div class="stat-value" id="total-bookings">0</div>
            <div class="stat-note" id="bookings-note"></div>
          </div>

          <!-- Revenue card with month/year selectors -->
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-title">
              <span>Revenue</span>
              <span class="inline-selects">
                <select id="rev-year"></select>
                <select id="rev-month"></select>
              </span>
            </div>
            <div class="stat-value" id="total-revenue">NU 0</div>
            <div class="stat-note" id="revenue-breakdown"></div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-title">Total Customers</div>
            <div class="stat-value" id="total-customers">0</div>
            <div class="stat-note" id="customers-note"></div>
          </div>
        </div>

        <div class="charts-container">
          <div class="chart-card">
            <h3>Revenue by Month</h3>
            <canvas id="revenueByMonthChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Booking Trends</h3>
            <canvas id="bookingChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Package Popularity</h3>
            <canvas id="packageChart"></canvas>
          </div>
        </div>

        <div class="section-header">
          <h2>Recent Bookings</h2>
          <button class="btn" id="view-all-bookings">
            <i class="fas fa-plus"></i> View All
          </button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Booking ID</th>
                <th>Customer</th>
                <th>Package</th>
                <th>Travel Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="recent-bookings-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Packages Section -->
      <div id="packages-section" class="content-section">
        <div class="section-header">
          <h2>Tour Packages Management</h2>
          <button class="btn" id="add-package-btn">
            <i class="fas fa-plus"></i> Add New Package
          </button>
        </div>
        <div class="package-grid" id="packages-grid"></div>
      </div>

      <!-- Bookings Section -->
      <div id="bookings-section" class="content-section">
        <div class="section-header">
          <h2>Bookings Management</h2>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Booking ID</th>
                <th>Customer</th>
                <th>Email & Phone</th>
                <th>Package</th>
                <th>Travel Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="all-bookings-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Events Section -->
      <div id="events-section" class="content-section">
        <div class="section-header">
          <h2>Events Management</h2>
          <button class="btn" id="add-event-btn">
            <i class="fas fa-plus"></i> Add New Event
          </button>
        </div>
        <div class="events-grid" id="events-grid"></div>
      </div>

      <!-- Testimonials Section -->
      <div id="testimonials-section" class="content-section">
        <div class="section-header">
          <h2>Testimonials Management</h2>
          <button class="btn" id="add-testimonial-btn">
            <i class="fas fa-plus"></i> Add New Testimonial
          </button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Avatar</th>
                <th>Author</th>
                <th>Package</th>
                <th>Rating</th>
                <th style="width: 40%">Review</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="testimonials-table-body">
              <!-- Rows will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- NEW: FAQ Section -->
      <div id="faq-section" class="content-section">
        <div class="section-header">
          <h2>FAQ Management</h2>
          <button class="btn" id="add-faq-btn">
            <i class="fas fa-plus"></i> Add New FAQ
          </button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Question</th>
                <th style="width: 50%">Answer</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="faq-table-body">
              <!-- FAQ rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Gallery Section -->
      <div id="gallery-section" class="content-section">
        <div class="section-header">
          <h2>Gallery Management</h2>
          <button class="btn" id="add-gallery-images-btn">
            <i class="fas fa-plus"></i> Add Images
          </button>
        </div>

        <div
          class="gallery-upload-area"
          id="gallery-upload-area"
          style="display: none"
        >
          <h3>Upload Gallery Images</h3>
          <p>
            Select up to 5 images for the gallery. Recommended size: 800x600
            pixels.
          </p>
          <div class="form-group">
            <input
              type="file"
              id="gallery-image-input"
              accept="image/*"
              multiple
              style="display: none"
            />
            <button
              type="button"
              class="btn btn-secondary"
              id="gallery-select-images"
            >
              <i class="fas fa-folder-open"></i> Select Images
            </button>
          </div>
          <div class="gallery-upload-preview" id="gallery-upload-preview"></div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              id="cancel-gallery-upload"
            >
              Cancel
            </button>
            <button type="button" class="btn" id="save-gallery-images">
              Save Gallery
            </button>
          </div>
        </div>

        <div class="gallery-grid" id="gallery-grid">
          <!-- Gallery images will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Add/Edit Package Modal -->
    <div class="modal-backdrop" id="package-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="package-modal-title">Add New Tour Package</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="package-form">
            <input type="hidden" id="package-slug-hidden" />
            <input type="hidden" id="package-image-url-hidden" />

            <div class="image-upload">
              <label>Package Image</label>
              <div class="image-upload-preview" id="package-image-preview">
                <div class="image-upload-placeholder">
                  <i class="fas fa-image"></i>
                  <p>Click to upload package image</p>
                </div>
              </div>
              <input
                type="file"
                id="package-image-input"
                accept="image/*"
                style="display: none"
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="package-title">Package Name</label>
                <input type="text" id="package-title" required />
              </div>
              <div class="form-group">
                <label for="package-location">Location</label>
                <input type="text" id="package-location" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="package-price-nu">Base Price (NU)</label>
                <input type="number" id="package-price-nu" min="0" required />
              </div>
              <div class="form-group">
                <label for="package-duration-text">Duration</label>
                <input
                  type="text"
                  id="package-duration-text"
                  placeholder="e.g., 7D/6N"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="package-travelers">Max Travelers</label>
                <input type="number" id="package-travelers" min="1" required />
              </div>
              <div class="form-group">
                <label for="package-type">Package Type</label>
                <select id="package-type" required>
                  <option value="">Select type</option>
                  <option value="beach">Beach</option>
                  <option value="mountain">Mountain</option>
                  <option value="cultural">Cultural</option>
                  <option value="adventure">Adventure</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="package-rating">Rating (0-5)</label>
              <input
                type="number"
                id="package-rating"
                min="0"
                max="5"
                step="0.1"
                required
                value="4.5"
              />
            </div>

            <div class="form-group">
              <label for="package-description">Package Description</label>
              <textarea id="package-description" required></textarea>
            </div>

            <div class="form-group">
              <label for="package-includes"
                >Package Features (comma-separated)</label
              >
              <textarea
                id="package-includes"
                placeholder="Accommodation, Breakfast, Guided Tours, etc."
                required
              ></textarea>
            </div>

            <div class="form-group" style="grid-column: 1 / -1">
              <label>Price Details</label>
              <div id="price-details-container"></div>
              <button
                type="button"
                class="btn btn-sm add-price-row-btn"
                style="margin-top: 10px; align-self: flex-start"
              >
                <i class="fas fa-plus"></i> Add Price Tier
              </button>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary close-modal">
                Cancel
              </button>
              <button type="submit" class="btn" id="package-form-submit-btn">
                Save Package
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Add/Edit Event Modal -->
    <div class="modal-backdrop" id="event-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="event-modal-title">Add New Event</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="event-form">
            <input type="hidden" id="event-id-hidden" />
            <input type="hidden" id="event-image-url-hidden" />

            <div class="image-upload">
              <label>Event Image</label>
              <div class="image-upload-preview" id="event-image-preview">
                <div class="image-upload-placeholder">
                  <i class="fas fa-image"></i>
                  <p>Click to upload event image</p>
                </div>
              </div>
              <input
                type="file"
                id="event-image-input"
                accept="image/*"
                style="display: none"
              />
            </div>

            <div class="form-group event-form-full">
              <label for="event-title">Event Title</label>
              <input type="text" id="event-title" required />
            </div>

            <div class="event-form-grid">
              <div class="form-group">
                <label for="event-location">Location</label>
                <input type="text" id="event-location" required />
              </div>
              <div class="form-group">
                <label for="event-date">Event Date</label>
                <input type="date" id="event-date" required />
              </div>
            </div>

            <div class="form-group event-form-full">
              <label for="event-description">Event Description</label>
              <textarea id="event-description" required rows="4"></textarea>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary close-modal">
                Cancel
              </button>
              <button type="submit" class="btn" id="event-form-submit-btn">
                Save Event
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Add/Edit Testimonial Modal -->
    <div class="modal-backdrop" id="testimonial-modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h3 id="testimonial-modal-title">Add New Testimonial</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="testimonial-form">
            <input type="hidden" id="testimonial-id-hidden" />
            <input type="hidden" id="testimonial-avatar-url-hidden" />

            <div class="testimonial-avatar-upload">
              <label>Avatar Image</label>
              <div
                class="testimonial-avatar-preview"
                id="testimonial-avatar-preview"
              >
                <div class="testimonial-avatar-placeholder">
                  <i class="fas fa-user-circle"></i>
                  <p>Click to upload</p>
                </div>
              </div>
              <input
                type="file"
                id="testimonial-avatar-input"
                accept="image/*"
                class="testimonial-avatar-input"
              />
              <div class="testimonial-avatar-upload-actions">
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="testimonial-select-avatar"
                >
                  <i class="fas fa-folder-open"></i> Select Image
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="testimonial-clear-avatar"
                >
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="testimonial-name">Author Name</label>
              <input type="text" id="testimonial-name" required />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="testimonial-location">Author Location</label>
                <input
                  type="text"
                  id="testimonial-location"
                  placeholder="e.g., New York, USA"
                  required
                />
              </div>
              <div class="form-group">
                <label for="testimonial-package">Package Reviewed</label>
                <input
                  type="text"
                  id="testimonial-package"
                  placeholder="e.g., Santorini Getaway"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="testimonial-rating">Rating (1-5)</label>
                <input
                  type="number"
                  id="testimonial-rating"
                  min="1"
                  max="5"
                  step="1"
                  required
                />
              </div>
            </div>

            <div class="form-group">
              <label for="testimonial-text">Review Text</label>
              <textarea id="testimonial-text" rows="4" required></textarea>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary close-modal">
                Cancel
              </button>
              <button
                type="submit"
                class="btn"
                id="testimonial-form-submit-btn"
              >
                Save Testimonial
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- NEW: Add/Edit FAQ Modal -->
    <div class="modal-backdrop" id="faq-modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3 id="faq-modal-title">Add New FAQ</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="faq-form">
            <input type="hidden" id="faq-id-hidden" />
            <div class="form-group">
              <label for="faq-question">Question</label>
              <textarea id="faq-question" rows="2" required></textarea>
            </div>
            <div class="form-group">
              <label for="faq-answer">Answer</label>
              <textarea id="faq-answer" rows="5" required></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary close-modal">
                Cancel
              </button>
              <button type="submit" class="btn" id="faq-form-submit-btn">
                Save FAQ
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Package Modal -->
    <div class="modal-backdrop" id="view-package-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Package Details</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div id="view-package-content"></div>
          <div class="form-actions" style="border-top: none; padding-top: 0">
            <button type="button" class="btn btn-secondary close-modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal-backdrop" id="profile-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3>Edit Profile</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="profile-form">
            <div class="form-group">
              <label for="profile-name">Full Name</label>
              <input type="text" id="profile-name" required />
            </div>
            <div class="form-group">
              <label for="profile-email">Email Address</label>
              <input type="email" id="profile-email" required />
            </div>
            <div class="form-group">
              <label for="profile-role">Role</label>
              <input type="text" id="profile-role" readonly />
            </div>
            <div class="form-group">
              <label for="profile-password"
                >New Password (leave blank to keep current)</label
              >
              <input type="password" id="profile-password" />
            </div>
            <div class="form-group">
              <label for="profile-confirm-password">Confirm New Password</label>
              <input type="password" id="profile-confirm-password" />
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary close-modal">
                Cancel
              </button>
              <button type="submit" class="btn" id="profile-form-submit-btn">
                Update Profile
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- BOOKING DETAIL MODAL -->
    <div class="modal-backdrop" id="booking-detail-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Booking Details</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="booking-detail-grid">
            <div class="booking-detail-group">
              <h4>Customer Information</h4>
              <div class="booking-detail-item">
                <span class="label">Name</span>
                <span class="value" id="detail-customer-name"></span>
              </div>
              <div class="booking-detail-item">
                <span class="label">Email</span>
                <span class="value" id="detail-customer-email"></span>
              </div>
              <div class="booking-detail-item">
                <span class="label">Phone</span>
                <span class="value" id="detail-customer-phone"></span>
              </div>
            </div>

            <div class="booking-detail-group">
              <h4>Trip Details</h4>
              <div class="booking-detail-item">
                <span class="label">Package</span>
                <span class="value" id="detail-package-name"></span>
              </div>
              <div class="booking-detail-item">
                <span class="label">Travel Date</span>
                <span class="value" id="detail-travel-date"></span>
              </div>
              <div class="booking-detail-item">
                <span class="label">Travelers</span>
                <span class="value" id="detail-travelers"></span>
              </div>
            </div>

            <div class="booking-detail-group">
              <h4>Booking & Payment</h4>
              <div class="booking-detail-item">
                <span class="label">Booking ID</span>
                <span class="value" id="detail-booking-id"></span>
              </div>
              <div class="booking-detail-item">
                <span class="label">Booking Date</span>
                <span class="value" id="detail-booking-date"></span>
              </div>
              <div class="booking-detail-item">
                <span class="label">Status</span>
                <span class="value" id="detail-booking-status"></span>
              </div>
              <div class="booking-detail-item">
                <span class="label">Total Amount</span>
                <span
                  class="value large"
                  id="detail-total-amount"
                  style="color: var(--primary-blue)"
                ></span>
              </div>
            </div>
          </div>
          <div class="form-actions" id="booking-detail-actions"></div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-backdrop" id="delete-confirm-modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3>Confirm Deletion</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div style="text-align: center; padding: 20px">
            <i
              class="fas fa-exclamation-triangle"
              style="
                font-size: 48px;
                color: var(--warning);
                margin-bottom: 20px;
              "
            ></i>
            <h3 style="margin-bottom: 15px">Are you sure?</h3>
            <p
              id="delete-modal-message"
              style="margin-bottom: 25px; color: var(--text-light)"
            >
              This action cannot be undone. The item will be permanently
              deleted.
            </p>
            <div
              style="
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
              "
            >
              <button type="button" class="btn btn-secondary close-modal">
                Cancel
              </button>
              <button type="button" class="btn btn-danger" id="confirm-delete">
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toast-message">Operation completed successfully!</span>
    </div>

    <script>
      // --- CONFIG ---
      const API_BASE_URL = "http://localhost:4000/api";

      // Cloudinary config (only used for images in Packages UI)
      const CLOUDINARY_CLOUD_NAME = "dcjhauih8";
      const CLOUDINARY_UPLOAD_PRESET = "Tourism";
      const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

      // State
      let currentAdmin = null; // <-- NEW: To store current admin data
      let packages = [];
      let bookings = [];
      let events = [];
      let galleryImages = [];
      let testimonials = [];
      let faqs = []; // NEW: FAQs state
      let galleryFilesToUpload = []; // MODIFIED: To hold selected gallery files
      let currentPackageSlug = null;
      let currentDeleteItem = { id: null, type: null }; // For generic delete modal
      let chartInstances = {};
      let monthlyRevenueCache = {}; // {year: [{month, byCurrency:[{currency,totalCents}], overallCents}]}

      // DOM refs
      const navItems = document.querySelectorAll(".nav-item");
      const contentSections = document.querySelectorAll(".content-section");
      const modals = document.querySelectorAll(".modal-backdrop");
      const closeModalButtons = document.querySelectorAll(".close-modal");
      const packageForm = document.getElementById("package-form");
      const packageFormSubmitBtn = document.getElementById(
        "package-form-submit-btn"
      );
      const addPackageBtn = document.getElementById("add-package-btn");
      const packagesGrid = document.getElementById("packages-grid");

      // Events DOM refs
      const addEventBtn = document.getElementById("add-event-btn");
      const eventsGrid = document.getElementById("events-grid");
      const eventForm = document.getElementById("event-form");
      const eventFormSubmitBtn = document.getElementById(
        "event-form-submit-btn"
      );
      const eventImagePreview = document.getElementById("event-image-preview");
      const eventImageInput = document.getElementById("event-image-input");

      // Testimonials DOM refs
      const addTestimonialBtn = document.getElementById("add-testimonial-btn");
      const testimonialsTableBody = document.getElementById(
        "testimonials-table-body"
      );
      const testimonialForm = document.getElementById("testimonial-form");
      const testimonialFormSubmitBtn = document.getElementById(
        "testimonial-form-submit-btn"
      );
      const testimonialAvatarPreview = document.getElementById(
        "testimonial-avatar-preview"
      );
      const testimonialAvatarInput = document.getElementById(
        "testimonial-avatar-input"
      );
      const testimonialSelectAvatarBtn = document.getElementById(
        "testimonial-select-avatar"
      );
      const testimonialClearAvatarBtn = document.getElementById(
        "testimonial-clear-avatar"
      );

      // NEW: FAQ DOM refs
      const addFaqBtn = document.getElementById("add-faq-btn");
      const faqTableBody = document.getElementById("faq-table-body");
      const faqForm = document.getElementById("faq-form");
      const faqFormSubmitBtn = document.getElementById("faq-form-submit-btn");

      const confirmDeleteBtn = document.getElementById("confirm-delete");
      const deleteModalMessage = document.getElementById(
        "delete-modal-message"
      );

      const toast = document.getElementById("toast");
      const toastMessage = document.getElementById("toast-message");
      const packageImagePreview = document.getElementById(
        "package-image-preview"
      );
      const packageImageInput = document.getElementById("package-image-input");
      const allBookingsBody = document.getElementById("all-bookings-body");
      const recentBookingsBody = document.getElementById(
        "recent-bookings-body"
      );

      // Profile modal refs
      const profileMenuTrigger = document.getElementById(
        "profile-menu-trigger"
      );
      const profileDropdown = document.getElementById("profile-dropdown");
      const profileModal = document.getElementById("profile-modal");
      const profileForm = document.getElementById("profile-form");
      const profileFormSubmitBtn = document.getElementById(
        "profile-form-submit-btn"
      );

      // Stats refs
      const totalPackagesEl = document.getElementById("total-packages");
      const totalBookingsEl = document.getElementById("total-bookings");
      const totalRevenueEl = document.getElementById("total-revenue");
      const totalCustomersEl = document.getElementById("total-customers");
      const revenueBreakdownEl = document.getElementById("revenue-breakdown");
      const packagesNoteEl = document.getElementById("packages-note");
      const bookingsNoteEl = document.getElementById("bookings-note");
      const customersNoteEl = document.getElementById("customers-note");

      // Revenue selectors
      const revYearEl = document.getElementById("rev-year");
      const revMonthEl = document.getElementById("rev-month");

      // Notifications DOM
      const notificationToggle = document.getElementById("notification-toggle");
      const notificationPanel = document.getElementById("notification-panel");
      const notificationBadge = document.getElementById("notification-badge");
      const notificationList = document.getElementById("notification-list");
      const clearNotificationsBtn = document.getElementById(
        "clear-notifications"
      );
      const viewAllNotificationsBtn = document.getElementById(
        "view-all-notifications"
      );

      // Gallery DOM
      const galleryUploadArea = document.getElementById("gallery-upload-area");
      const galleryGrid = document.getElementById("gallery-grid");
      const galleryImageInput = document.getElementById("gallery-image-input");
      const gallerySelectImagesBtn = document.getElementById(
        "gallery-select-images"
      );
      const galleryUploadPreview = document.getElementById(
        "gallery-upload-preview"
      );
      const saveGalleryImagesBtn = document.getElementById(
        "save-gallery-images"
      );
      const cancelGalleryUploadBtn = document.getElementById(
        "cancel-gallery-upload"
      );
      const addGalleryImagesBtn = document.getElementById(
        "add-gallery-images-btn"
      );

      async function initDashboard() {
        // Assume login is handled elsewhere and token is in sessionStorage
        if (!sessionStorage.getItem("tv_admin_token")) {
          // In a real app, you would redirect to a login page
          // window.location.href = '/login.html';
          console.warn(
            "Admin token not found. API calls to protected routes will fail."
          );
          // Optional: redirect to login if no token is found
          // window.location.href = '/admin-login.html';
          // return;
        }

        await fetchAndDisplayAdminDetails(); // <-- NEW: Fetch admin data first

        await Promise.all([
          fetchAndRenderPackages(),
          fetchAndRenderBookings(),
          fetchAndRenderEvents(),
          fetchAndRenderGallery(),
          fetchAndRenderTestimonials(),
          fetchAndRenderFaqs(),
        ]);

        await updateStatsFromServer(); // overview
        initRevenueSelectors(); // month/year controls
        await hydrateRevenueYear(getNow().year); // fetch + chart
        updateRevenueCardForSelection(); // fill card with selected month
        initCharts(); // draw booking & popularity charts
        setupEventListeners();
        setupImageUploads();
        setupNotificationUI();
        setupGalleryUI();
        setupTestimonialAvatarUpload();
        updateNotificationsUI();
      }

      function getNow() {
        const d = new Date();
        return { year: d.getFullYear(), month: d.getMonth() + 1 };
      }

      function getAuthHeaders() {
        const headers = { "Content-Type": "application/json" };
        const token = sessionStorage.getItem("tv_admin_token");
        if (token) {
          headers["Authorization"] = `Bearer ${token}`;
        }
        return headers;
      }

      /* -------------------- FAQ MANAGEMENT (NEW) -------------------- */
      async function fetchAndRenderFaqs() {
        try {
          const response = await fetch(`${API_BASE_URL}/faqs`);
          if (!response.ok) throw new Error("Failed to fetch FAQs");
          faqs = await response.json();
          renderFaqs();
        } catch (error) {
          console.error("Error fetching FAQs:", error);
          showToast(error.message, true);
        }
      }

      function renderFaqs() {
        faqTableBody.innerHTML = "";
        if (faqs.length === 0) {
          faqTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 40px;">No FAQs found. Add one to get started!</td></tr>`;
          return;
        }

        faqs.forEach((faq) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><strong>${escapeHtml(faq.question)}</strong></td>
            <td>${escapeHtml(faq.answer.substring(0, 150))}${
            faq.answer.length > 150 ? "..." : ""
          }</td>
            <td>
              <button class="action-btn edit-faq-btn" title="Edit" data-faq-id="${
                faq._id
              }"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete-faq-btn" title="Delete" data-faq-id="${
                faq._id
              }"><i class="fas fa-trash"></i></button>
            </td>
          `;
          faqTableBody.appendChild(row);
        });
      }

      function openFaqModalForCreate() {
        faqForm.reset();
        document.getElementById("faq-modal-title").textContent = "Add New FAQ";
        document.getElementById("faq-id-hidden").value = "";
        faqFormSubmitBtn.textContent = "Save FAQ";
        openModal("faq-modal");
      }

      function openFaqModalForEdit(faqId) {
        const faq = faqs.find((f) => f._id === faqId);
        if (!faq) {
          showToast("Could not find FAQ to edit.", true);
          return;
        }

        faqForm.reset();
        document.getElementById("faq-modal-title").textContent = "Edit FAQ";
        document.getElementById("faq-id-hidden").value = faq._id;
        document.getElementById("faq-question").value = faq.question;
        document.getElementById("faq-answer").value = faq.answer;

        faqFormSubmitBtn.textContent = "Update FAQ";
        openModal("faq-modal");
      }

      async function handleFaqFormSubmit() {
        const faqId = document.getElementById("faq-id-hidden").value;
        const isEditing = !!faqId;

        const faqData = {
          question: document.getElementById("faq-question").value,
          answer: document.getElementById("faq-answer").value,
        };

        faqFormSubmitBtn.disabled = true;
        faqFormSubmitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
          const url = isEditing
            ? `${API_BASE_URL}/faqs/${faqId}`
            : `${API_BASE_URL}/faqs`;
          const method = isEditing ? "PATCH" : "POST";
          const res = await fetch(url, {
            method,
            headers: getAuthHeaders(),
            body: JSON.stringify(faqData),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "Save failed");
          }

          closeModal(document.getElementById("faq-modal"));
          showToast(`FAQ ${isEditing ? "updated" : "added"}!`);
          await fetchAndRenderFaqs();
        } catch (error) {
          showToast(`Error: ${error.message}`, true);
        } finally {
          faqFormSubmitBtn.disabled = false;
          faqFormSubmitBtn.textContent = isEditing ? "Update FAQ" : "Save FAQ";
        }
      }

      async function deleteFaq(faqId) {
        currentDeleteItem = { id: faqId, type: "FAQ" };
        deleteModalMessage.textContent =
          "Are you sure you want to delete this FAQ? This action cannot be undone.";
        openModal("delete-confirm-modal");
      }

      /* -------------------- TESTIMONIALS MANAGEMENT -------------------- */
      async function fetchAndRenderTestimonials() {
        try {
          const response = await fetch(`${API_BASE_URL}/testimonials`);
          if (response.ok) {
            testimonials = await response.json();
            renderTestimonials();
          } else {
            console.error("Failed to fetch testimonials");
            showToast("Failed to fetch testimonials", true);
            testimonials = [];
            renderTestimonials();
          }
        } catch (error) {
          console.error("Error fetching testimonials:", error);
          showToast("Error fetching testimonials", true);
        }
      }

      function renderTestimonials() {
        testimonialsTableBody.innerHTML = "";
        if (testimonials.length === 0) {
          testimonialsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px;">No testimonials found. Add one to get started!</td></tr>`;
          return;
        }

        testimonials.forEach((t) => {
          const row = document.createElement("tr");

          const ratingStars = Array(5)
            .fill(0)
            .map(
              (_, i) =>
                `<i class="fas fa-star" style="color: ${
                  i < t.rating ? "var(--warning)" : "var(--border-color)"
                };"></i>`
            )
            .join("");

          row.innerHTML = `
                  <td><img src="${t.avatar}" alt="${
            t.name
          }" class="testimonial-avatar-sm"></td>
                  <td><strong>${t.name}</strong><br><small>${
            t.location
          }</small></td>
                  <td>${t.package}</td>
                  <td><div class="rating-stars">${ratingStars}</div></td>
                  <td>${t.text.substring(0, 100)}${
            t.text.length > 100 ? "..." : ""
          }</td>
                  <td>
                      <button class="action-btn edit-testimonial-btn" title="Edit" data-testimonial-id="${
                        t._id
                      }"><i class="fas fa-edit"></i></button>
                      <button class="action-btn delete-testimonial-btn" title="Delete" data-testimonial-id="${
                        t._id
                      }"><i class="fas fa-trash"></i></button>
                  </td>
              `;
          testimonialsTableBody.appendChild(row);
        });
      }

      function openTestimonialModalForCreate() {
        testimonialForm.reset();
        document.getElementById("testimonial-modal-title").textContent =
          "Add New Testimonial";
        document.getElementById("testimonial-id-hidden").value = "";
        document.getElementById("testimonial-avatar-url-hidden").value = "";

        // Reset avatar preview
        testimonialAvatarPreview.innerHTML = `
          <div class="testimonial-avatar-placeholder">
            <i class="fas fa-user-circle"></i>
            <p>Click to upload</p>
          </div>
        `;

        testimonialFormSubmitBtn.textContent = "Save Testimonial";
        openModal("testimonial-modal");
      }

      function openTestimonialModalForEdit(testimonialId) {
        const testimonial = testimonials.find((t) => t._id === testimonialId);
        if (!testimonial) {
          showToast("Could not find testimonial to edit.", true);
          return;
        }

        testimonialForm.reset();
        document.getElementById("testimonial-modal-title").textContent =
          "Edit Testimonial";
        document.getElementById("testimonial-id-hidden").value =
          testimonial._id;
        document.getElementById("testimonial-avatar-url-hidden").value =
          testimonial.avatar;
        document.getElementById("testimonial-name").value = testimonial.name;
        document.getElementById("testimonial-location").value =
          testimonial.location;
        document.getElementById("testimonial-package").value =
          testimonial.package;
        document.getElementById("testimonial-rating").value =
          testimonial.rating;
        document.getElementById("testimonial-text").value = testimonial.text;

        // Set avatar preview
        if (testimonial.avatar) {
          testimonialAvatarPreview.innerHTML = `<img src="${testimonial.avatar}" alt="Avatar Preview">`;
        } else {
          testimonialAvatarPreview.innerHTML = `
            <div class="testimonial-avatar-placeholder">
              <i class="fas fa-user-circle"></i>
              <p>Click to upload</p>
            </div>
          `;
        }

        testimonialFormSubmitBtn.textContent = "Update Testimonial";
        openModal("testimonial-modal");
      }

      async function handleTestimonialFormSubmit() {
        const testimonialId = document.getElementById(
          "testimonial-id-hidden"
        ).value;
        const isEditing = !!testimonialId;

        // Get the avatar URL (either from hidden input or from file upload)
        let avatarUrl = document.getElementById(
          "testimonial-avatar-url-hidden"
        ).value;
        const file = testimonialAvatarInput.files[0];

        testimonialFormSubmitBtn.disabled = true;
        testimonialFormSubmitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
          // If a new file is selected, upload it to Cloudinary
          if (file) {
            testimonialFormSubmitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Uploading Image...';
            avatarUrl = await uploadImageToCloudinary(file);
            if (!avatarUrl) {
              throw new Error("Avatar image upload failed. Please try again.");
            }
          }

          // If no avatar URL is set (and no file was uploaded), show error
          if (!avatarUrl) {
            throw new Error(
              "Please select an avatar image for the testimonial."
            );
          }

          const testimonialData = {
            name: document.getElementById("testimonial-name").value,
            location: document.getElementById("testimonial-location").value,
            package: document.getElementById("testimonial-package").value,
            rating: parseInt(
              document.getElementById("testimonial-rating").value,
              10
            ),
            avatar: avatarUrl,
            text: document.getElementById("testimonial-text").value,
          };

          const url = isEditing
            ? `${API_BASE_URL}/testimonials/${testimonialId}`
            : `${API_BASE_URL}/testimonials`;
          const method = isEditing ? "PATCH" : "POST";

          const res = await fetch(url, {
            method,
            headers: getAuthHeaders(),
            body: JSON.stringify(testimonialData),
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "Save failed");
          }

          closeModal(document.getElementById("testimonial-modal"));
          showToast(`Testimonial ${isEditing ? "updated" : "added"}!`);
          await fetchAndRenderTestimonials();
        } catch (error) {
          showToast(`Error: ${error.message}`, true);
        } finally {
          testimonialFormSubmitBtn.disabled = false;
          testimonialFormSubmitBtn.textContent = isEditing
            ? "Update Testimonial"
            : "Save Testimonial";
        }
      }

      function deleteTestimonial(testimonialId) {
        currentDeleteItem = { id: testimonialId, type: "Testimonial" };
        deleteModalMessage.textContent =
          "Are you sure you want to delete this testimonial? This action cannot be undone.";
        openModal("delete-confirm-modal");
      }

      function setupTestimonialAvatarUpload() {
        // Click on preview to open file selector
        testimonialAvatarPreview.addEventListener("click", () => {
          testimonialAvatarInput.click();
        });

        // Select avatar button
        testimonialSelectAvatarBtn.addEventListener("click", () => {
          testimonialAvatarInput.click();
        });

        // Clear avatar button
        testimonialClearAvatarBtn.addEventListener("click", () => {
          testimonialAvatarInput.value = "";
          document.getElementById("testimonial-avatar-url-hidden").value = "";
          testimonialAvatarPreview.innerHTML = `
            <div class="testimonial-avatar-placeholder">
              <i class="fas fa-user-circle"></i>
              <p>Click to upload</p>
            </div>
          `;
        });

        // Handle file selection
        testimonialAvatarInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
              testimonialAvatarPreview.innerHTML = `<img src="${e.target.result}" alt="Avatar Preview">`;
            };
            reader.readAsDataURL(this.files[0]);

            // Clear the URL hidden field when a new file is selected
            document.getElementById("testimonial-avatar-url-hidden").value = "";
          }
        });
      }

      /* -------------------- EVENTS MANAGEMENT -------------------- */
      async function fetchAndRenderEvents() {
        try {
          const response = await fetch(`${API_BASE_URL}/events`);
          if (response.ok) {
            events = await response.json();
            renderEvents();
          } else {
            const err = await response.json();
            throw new Error(err.error || "Failed to fetch events");
          }
        } catch (error) {
          console.error("Error fetching events:", error);
          showToast(error.message, true);
          events = [];
          renderEvents();
        }
      }

      function renderEvents() {
        eventsGrid.innerHTML = "";

        if (events.length === 0) {
          eventsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-light);">
              <i class="fas fa-calendar-alt" style="font-size: 48px; margin-bottom: 16px;"></i>
              <h3>No events found</h3>
              <p>Click "Add New Event" to create your first event</p>
            </div>
          `;
          return;
        }

        events.forEach((event) => {
          const eventCard = document.createElement("div");
          eventCard.className = "event-card";
          const eventDate = new Date(event.date);
          const now = new Date();
          now.setHours(0, 0, 0, 0); // Compare dates only

          let status = "upcoming";
          let statusText = "Upcoming";

          if (eventDate < now) {
            status = "completed";
            statusText = "Completed";
          } else if (eventDate.getTime() === now.getTime()) {
            status = "ongoing";
            statusText = "Today";
          }

          eventCard.innerHTML = `
            <div class="event-image">
              <img src="${
                event.image ||
                "https://images.unsplash.com/photo-1540575467063-178a50c2df87?auto=format&fit=crop&w=600&q=80"
              }" alt="${event.title}">
            </div>
            <div class="event-content">
              <span class="event-status ${status}" style="align-self: flex-start; margin-bottom: 8px;">${statusText}</span>
              <h3 class="event-title">${escapeHtml(event.title)}</h3>
               <div class="event-price">
                ${
                  event.price > 0
                    ? `NU ${event.price.toLocaleString()}`
                    : "Free"
                }
              </div>
              <div class="event-location">
                <i class="fas fa-map-marker-alt"></i> ${escapeHtml(
                  event.location
                )}
              </div>
              <p class="event-description">${escapeHtml(
                event.description.substring(0, 100)
              )}...</p>
              <div class="event-meta">
                <div class="event-date">
                  <i class="far fa-calendar"></i> ${formatEventDate(eventDate)}
                </div>
                <div class="event-date">
                   <i class="far fa-clock"></i> ${formatTime(event.time)}
                </div>
                 <div class="event-date">
                   <i class="fas fa-users"></i> ${event.capacity} Max
                </div>
              </div>
              <div class="event-actions">
                <button class="btn edit-event-btn" data-event-id="${event._id}">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-danger delete-event-btn" data-event-id="${
                  event._id
                }">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          `;
          eventsGrid.appendChild(eventCard);
        });
      }

      function formatEventDate(date) {
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function formatTime(timeStr) {
        if (!timeStr) return "";
        const [hour, minute] = timeStr.split(":");
        const h = parseInt(hour, 10);
        const suffix = h >= 12 ? "PM" : "AM";
        const hour12 = ((h + 11) % 12) + 1;
        return `${hour12}:${minute} ${suffix}`;
      }

      function openEventModalForCreate() {
        eventForm.reset();
        document.getElementById("event-modal-title").textContent =
          "Add New Event";
        document.getElementById("event-id-hidden").value = "";
        document.getElementById("event-image-url-hidden").value = "";
        eventImagePreview.innerHTML = `
          <div class="image-upload-placeholder">
            <i class="fas fa-image"></i>
            <p>Click to upload event image</p>
          </div>`;
        eventFormSubmitBtn.textContent = "Save Event";

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("event-date").min = today;

        openModal("event-modal");
      }

      function openEventModalForEdit(eventId) {
        const event = events.find((e) => e._id === eventId);
        if (!event) {
          showToast("Could not find event to edit.", true);
          return;
        }

        eventForm.reset();
        document.getElementById("event-modal-title").textContent = "Edit Event";
        document.getElementById("event-id-hidden").value = event._id;
        document.getElementById("event-image-url-hidden").value = event.image;
        document.getElementById("event-title").value = event.title;
        document.getElementById("event-location").value = event.location;
        document.getElementById("event-date").value = new Date(event.date)
          .toISOString()
          .split("T")[0];
        document.getElementById("event-description").value = event.description;

        if (event.image) {
          eventImagePreview.innerHTML = `<img src="${event.image}" alt="Event Image">`;
        } else {
          eventImagePreview.innerHTML = `
            <div class="image-upload-placeholder">
              <i class="fas fa-image"></i>
              <p>Click to upload event image</p>
            </div>`;
        }

        eventFormSubmitBtn.textContent = "Update Event";
        openModal("event-modal");
      }

      async function handleEventFormSubmit() {
        let imageUrl = document.getElementById("event-image-url-hidden").value;
        const file = eventImageInput?.files?.[0];

        eventFormSubmitBtn.disabled = true;
        eventFormSubmitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
          if (file) {
            eventFormSubmitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Uploading Image...';
            imageUrl = await uploadImageToCloudinary(file);
            if (!imageUrl) {
              throw new Error("Image upload failed. Please try again.");
            }
          }

          if (!imageUrl) {
            throw new Error("Please select an image for the event.");
          }

          const eventId = document.getElementById("event-id-hidden").value;
          const isEditing = !!eventId;

          const eventData = {
            title: document.getElementById("event-title").value,
            location: document.getElementById("event-location").value,
            date: document.getElementById("event-date").value,
            description: document.getElementById("event-description").value,
            image: imageUrl,
          };

          const url = isEditing
            ? `${API_BASE_URL}/events/${eventId}`
            : `${API_BASE_URL}/events`;
          const method = isEditing ? "PATCH" : "POST";

          const res = await fetch(url, {
            method,
            headers: getAuthHeaders(),
            body: JSON.stringify(eventData),
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "Save failed");
          }

          closeModal(document.getElementById("event-modal"));
          showToast(`Event ${isEditing ? "updated" : "added"}!`);
          await fetchAndRenderEvents();
        } catch (error) {
          showToast(`Error: ${error.message}`, true);
        } finally {
          eventFormSubmitBtn.disabled = false;
          eventFormSubmitBtn.textContent = "Save Event";
        }
      }

      function deleteEvent(eventId) {
        currentDeleteItem = { id: eventId, type: "Event" };
        deleteModalMessage.textContent =
          "Are you sure you want to delete this event? This action cannot be undone.";
        openModal("delete-confirm-modal");
      }

      /* -------------------- GENERIC DELETE HANDLER -------------------- */
      async function handleConfirmDelete() {
        const { id, type } = currentDeleteItem;
        if (!id || !type) return;

        const endpointMap = {
          Package: `packages/${id}`,
          Event: `events/${id}`,
          Testimonial: `testimonials/${id}`,
          FAQ: `faqs/${id}`,
        };

        const refreshMap = {
          Package: fetchAndRenderPackages,
          Event: fetchAndRenderEvents,
          Testimonial: fetchAndRenderTestimonials,
          FAQ: fetchAndRenderFaqs,
        };

        const endpoint = endpointMap[type];
        const refreshFunction = refreshMap[type];

        if (!endpoint) {
          showToast("Invalid item type for deletion.", true);
          return;
        }

        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        try {
          const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
            method: "DELETE",
            headers: getAuthHeaders(),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || `Failed to delete ${type}`);
          }

          showToast(`${type} deleted successfully!`);
          closeModal(document.getElementById("delete-confirm-modal"));
          if (refreshFunction) {
            await refreshFunction();
          }
        } catch (error) {
          showToast(error.message, true);
        } finally {
          confirmDeleteBtn.disabled = false;
          confirmDeleteBtn.textContent = "Delete";
          currentDeleteItem = { id: null, type: null };
        }
      }

      /* -------------------- GALLERY MANAGEMENT (REVISED) -------------------- */
      function setupGalleryUI() {
        gallerySelectImagesBtn.addEventListener("click", () => {
          galleryImageInput.click();
        });

        galleryImageInput.addEventListener(
          "change",
          handleGalleryImageSelection
        );
        saveGalleryImagesBtn.addEventListener("click", saveGalleryImages);
        cancelGalleryUploadBtn.addEventListener("click", cancelGalleryUpload);
        addGalleryImagesBtn.addEventListener("click", showGalleryUpload);
      }

      function showGalleryUpload() {
        galleryUploadArea.style.display = "block";
        addGalleryImagesBtn.style.display = "none";
      }

      function cancelGalleryUpload() {
        galleryUploadArea.style.display = "none";
        addGalleryImagesBtn.style.display = "inline-flex";
        galleryUploadPreview.innerHTML = "";
        galleryFilesToUpload = []; // Clear the file array
        galleryImageInput.value = ""; // Reset the file input
      }

      function renderGalleryUploadPreviews() {
        galleryUploadPreview.innerHTML = "";
        galleryFilesToUpload.forEach((file, index) => {
          const previewItem = document.createElement("div");
          previewItem.className = "gallery-upload-item";
          const imageSrc = URL.createObjectURL(file);
          previewItem.innerHTML = `
              <img src="${imageSrc}" alt="Preview ${file.name}">
              <button type="button" class="remove-btn remove-gallery-preview-btn" data-index="${index}">
                  <i class="fas fa-times"></i>
              </button>
          `;
          galleryUploadPreview.appendChild(previewItem);
        });
      }

      function handleGalleryImageSelection(e) {
        const newFiles = Array.from(e.target.files);
        galleryFilesToUpload = newFiles.slice(0, 5); // Limit to 5 files
        renderGalleryUploadPreviews();
        e.target.value = "";
      }

      async function saveGalleryImages() {
        if (galleryFilesToUpload.length === 0) {
          showToast("Please select at least one image", true);
          return;
        }

        saveGalleryImagesBtn.disabled = true;
        saveGalleryImagesBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Uploading...';

        try {
          const uploadPromises = galleryFilesToUpload.map(async (file) => {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

            const uploadResponse = await fetch(CLOUDINARY_UPLOAD_URL, {
              method: "POST",
              body: formData,
            });

            if (!uploadResponse.ok) {
              const err = await uploadResponse.json().catch(() => ({}));
              console.error("Cloudinary upload failed:", err);
              throw new Error(`Upload failed for ${file.name}`);
            }
            const data = await uploadResponse.json();
            return data.secure_url;
          });

          const imageUrls = await Promise.all(uploadPromises);

          // Save to backend
          const saveResponse = await fetch(`${API_BASE_URL}/gallery`, {
            method: "POST",
            headers: getAuthHeaders(),
            body: JSON.stringify({ images: imageUrls }),
          });

          if (!saveResponse.ok)
            throw new Error("Failed to save gallery to backend");

          showToast("Gallery images saved successfully!");
          cancelGalleryUpload();
          await fetchAndRenderGallery();
        } catch (error) {
          console.error("Gallery upload error:", error);
          showToast(error.message || "Failed to upload gallery images", true);
        } finally {
          saveGalleryImagesBtn.disabled = false;
          saveGalleryImagesBtn.innerHTML = "Save Gallery";
        }
      }

      async function fetchAndRenderGallery() {
        try {
          const response = await fetch(`${API_BASE_URL}/gallery`);
          if (response.ok) {
            const data = await response.json();
            galleryImages = data.images || [];
            renderGallery();
          }
        } catch (error) {
          console.error("Failed to fetch gallery:", error);
          // Initialize with empty gallery if fetch fails
          galleryImages = [];
          renderGallery();
        }
      }

      function renderGallery() {
        galleryGrid.innerHTML = "";

        if (galleryImages.length === 0) {
          galleryGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-light);">
              <i class="fas fa-images" style="font-size: 48px; margin-bottom: 16px;"></i>
              <h3>No gallery images</h3>
              <p>Click "Add Images" to upload photos for the website gallery</p>
            </div>
          `;
          return;
        }

        galleryImages.forEach((imageUrl, index) => {
          const galleryItem = document.createElement("div");
          galleryItem.className = "gallery-item";
          galleryItem.innerHTML = `
            <img src="${imageUrl}" alt="Gallery image ${index + 1}">
            <div class="gallery-item-actions">
              <button class="gallery-item-action delete-gallery-image" data-index="${index}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          galleryGrid.appendChild(galleryItem);
        });
      }

      async function deleteGalleryImage(index) {
        if (!confirm("Are you sure you want to delete this image?")) return;

        try {
          const updatedImages = [...galleryImages];
          updatedImages.splice(index, 1);

          const response = await fetch(`${API_BASE_URL}/gallery`, {
            method: "POST",
            headers: getAuthHeaders(),
            body: JSON.stringify({ images: updatedImages }),
          });

          if (!response.ok) throw new Error("Failed to delete image");

          showToast("Image deleted successfully");
          await fetchAndRenderGallery();
        } catch (error) {
          console.error("Delete gallery image error:", error);
          showToast("Failed to delete image", true);
        }
      }

      /* ==================== NEW/MODIFIED FUNCTIONS FOR PROFILE & LOGOUT ==================== */

      /**
       * Fetches admin details from the backend and updates the UI.
       */
      async function fetchAndDisplayAdminDetails() {
        try {
          const response = await fetch(`${API_BASE_URL}/admin/me`, {
            headers: getAuthHeaders(),
          });

          if (!response.ok) {
            throw new Error("Could not fetch admin details.");
          }

          const admin1 = await response.json();
          const admin = admin1.admin;

          console.log("admin details", admin);
          currentAdmin = admin; // Store admin data globally
          console.log("currentAdmin", currentAdmin);

          // Update UI elements
          document.getElementById("admin-user-name").textContent =
            admin.firstName || "Admin User";
          document.getElementById("admin-user-role").textContent =
            admin.role || "Administrator";

          // Update avatar with initials
          const initials =
            admin.fullName
              ?.split(" ")
              .map((n) => n[0])
              .join("")
              .toUpperCase() || "AD";
          document.getElementById("admin-user-avatar").textContent = initials;
        } catch (error) {
          console.error("Error fetching admin details:", error);
          showToast(error.message, true);
          // If profile fetch fails, maybe log out
          // logout();
        }
      }

      /**
       * Populates the profile modal with the current admin's data.
       */
      function openProfileModal() {
        // console.log(Boolean(!currentAdmin));
        if (!currentAdmin) {
          showToast("Admin data not loaded yet. Please try again.", true);
          return;
        }

        fullName = currentAdmin.firstName + " " + currentAdmin.lastName;
        // console.log("fullname", fullName);
        // Fill the form with current data
        document.getElementById("profile-name").value = fullName;
        document.getElementById("profile-email").value = currentAdmin.email;

        document.getElementById("profile-role").value = currentAdmin.role;

        // Clear password fields
        document.getElementById("profile-password").value = "";
        document.getElementById("profile-confirm-password").value = "";

        openModal("profile-modal");
      }

      /**
       * Handles the submission of the profile update form.
       */
      async function handleProfileFormSubmit(e) {
        e.preventDefault();

        const name = document.getElementById("profile-name").value;
        const email = document.getElementById("profile-email").value;
        const password = document.getElementById("profile-password").value;
        const confirmPassword = document.getElementById(
          "profile-confirm-password"
        ).value;

        if (password && password !== confirmPassword) {
          showToast("New passwords do not match.", true);
          return;
        }

        const updateData = {
          fullName: name,
          email: email,
        };

        // Only include the password in the request if it's being changed
        if (password) {
          updateData.password = password;
        }

        profileFormSubmitBtn.disabled = true;
        profileFormSubmitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Updating...';

        try {
          const response = await fetch(`${API_BASE_URL}/admin/me`, {
            method: "PATCH",
            headers: getAuthHeaders(),
            body: JSON.stringify(updateData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to update profile.");
          }

          showToast("Profile updated successfully!");
          closeModal(profileModal);
          await fetchAndDisplayAdminDetails(); // Re-fetch data to update UI
        } catch (error) {
          showToast(`Update failed: ${error.message}`, true);
        } finally {
          profileFormSubmitBtn.disabled = false;
          profileFormSubmitBtn.textContent = "Update Profile";
        }
      }

      /**
       * Handles the admin logout process.
       */
      async function logout() {
        showToast("Logging out...");
        try {
          // Optional: Inform the backend about the logout
          await fetch(`${API_BASE_URL}/auth/logout`, {
            method: "POST",
            headers: getAuthHeaders(),
          });
        } catch (error) {
          console.error("Logout API call failed, proceeding to logout.", error);
        } finally {
          // ALWAYS clear the token and redirect
          sessionStorage.removeItem("tv_admin_token");
          setTimeout(() => {
            // Replace with your actual login page URL
            window.location.href = "admin-login.html";
          }, 500);
        }
      }

      /* =================================================================================== */

      /* -------------------- SERVER STATS -------------------- */
      async function fetchStatsOverview() {
        const res = await fetch(`${API_BASE_URL}/stats/overview`, {
          headers: getAuthHeaders(),
        });
        if (!res.ok) {
          let errMsg = "Failed to fetch stats";
          try {
            const e = await res.json();
            if (e?.error) errMsg = e.error;
          } catch {}
          throw new Error(errMsg);
        }
        return res.json();
      }

      function centsToCurrencyString(totalCents, currencyCode = "NU") {
        if (totalCents === null || totalCents === undefined) return "N/A";
        const amount = totalCents / 100;
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: currencyCode === "NU" ? "BTN" : currencyCode,
          minimumFractionDigits: 2,
        })
          .format(amount)
          .replace("BTN", currencyCode);
      }

      async function updateStatsFromServer() {
        try {
          const data = await fetchStatsOverview();

          totalPackagesEl.textContent = data?.totals?.packages ?? 0;
          totalBookingsEl.textContent = data?.totals?.confirmedBookings ?? 0;
          totalCustomersEl.textContent = data?.totals?.customers ?? 0;

          const byCurrency = Array.isArray(data?.revenue?.byCurrency)
            ? data.revenue.byCurrency
            : [];
          if (byCurrency.length === 0) {
            totalRevenueEl.textContent = "NU 0.00";
            revenueBreakdownEl.textContent = "";
          } else if (byCurrency.length === 1) {
            const r = byCurrency[0];
            totalRevenueEl.textContent = centsToCurrencyString(
              r.totalCents,
              r.currency || "NU"
            );
            revenueBreakdownEl.textContent = "";
          } else {
            totalRevenueEl.textContent =
              centsToCurrencyString(data.revenue.overallCents, "NU") +
              " (overall)";
            const top = byCurrency
              .slice()
              .sort((a, b) => (b.totalCents || 0) - (a.totalCents || 0))
              .slice(0, 3)
              .map(
                (r) =>
                  `${r.currency}: ${centsToCurrencyString(
                    r.totalCents,
                    r.currency
                  )}`
              )
              .join(" • ");
            revenueBreakdownEl.textContent =
              top + (byCurrency.length > 3 ? " • …" : "");
          }

          packagesNoteEl.textContent = "";
          bookingsNoteEl.textContent = "";
          customersNoteEl.textContent = "";
        } catch (error) {
          showToast(`Stats error: ${error.message}`, true);
          // Fallback using client data
          totalPackagesEl.textContent = packages.length;
          const confirmed = bookings.filter((b) => b.status === "CONFIRMED");
          totalBookingsEl.textContent = confirmed.length;
          const totalCents = confirmed.reduce(
            (s, b) => s + (b.pricing?.totalGroupCents || 0),
            0
          );
          totalRevenueEl.textContent = centsToCurrencyString(
            totalCents,
            confirmed[0]?.pricing?.currency || "NU"
          );
          const totalTravelers = confirmed.reduce(
            (s, b) => s + (b.trip?.travelers || 0),
            0
          );
          totalCustomersEl.textContent = totalTravelers;
          revenueBreakdownEl.textContent = "(fallback from client data)";
          bookingsNoteEl.textContent = "(confirmed only)";
        }
      }

      /* -------------------- MONTHLY REVENUE (client + optional server) -------------------- */
      function initRevenueSelectors() {
        const { year, month } = getNow();
        const years = [year, year - 1, year - 2, year - 3, year - 4];
        revYearEl.innerHTML = years
          .map((y) => `<option value="${y}">${y}</option>`)
          .join("");
        revYearEl.value = String(year);

        const names = [
          "Jan",
          "Feb",

          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        revMonthEl.innerHTML = names
          .map((n, i) => `<option value="${i + 1}">${n}</option>`)
          .join("");
        revMonthEl.value = String(month);

        revYearEl.addEventListener("change", async () => {
          await hydrateRevenueYear(Number(revYearEl.value));
          updateRevenueCardForSelection();
          drawRevenueByMonthChart();
          drawBookingTrendChart();
          drawPackagePopularityChart();
        });
        revMonthEl.addEventListener("change", () => {
          updateRevenueCardForSelection();
        });
      }

      async function hydrateRevenueYear(year) {
        if (monthlyRevenueCache[year]) {
          drawRevenueByMonthChart();
          return;
        }
        // Try server first (optional endpoint; falls back to client)
        try {
          const res = await fetch(
            `${API_BASE_URL}/stats/revenue-by-month?from=${year}-01-01&to=${
              year + 1
            }-01-01`,
            { headers: getAuthHeaders() }
          );
          if (!res.ok) throw new Error("Server monthly revenue not available");
          const data = await res.json();
          monthlyRevenueCache[year] = normalizeMonthlyRevenue(data, year);
        } catch {
          monthlyRevenueCache[year] = computeMonthlyRevenueFromClient(
            year,
            bookings
          );
        }
        drawRevenueByMonthChart();
      }

      function normalizeMonthlyRevenue(revenueData, year) {
        const byMonth = new Map();
        (revenueData || []).forEach((item) => {
          const monthNum = parseInt(item.month.split("-")[1], 10);
          if (!byMonth.has(monthNum)) {
            byMonth.set(monthNum, {
              month: monthNum,
              byCurrency: [],
              overallCents: 0,
            });
          }
          const monthData = byMonth.get(monthNum);
          monthData.byCurrency.push({
            currency: item.currency,
            totalCents: item.totalCents,
          });
          monthData.overallCents += item.totalCents;
        });

        const result = [];
        for (let i = 1; i <= 12; i++) {
          if (byMonth.has(i)) {
            result.push(byMonth.get(i));
          } else {
            result.push({ month: i, byCurrency: [], overallCents: 0 });
          }
        }
        return result;
      }

      function computeMonthlyRevenueFromClient(year, allBookings) {
        const confirmed = (allBookings || []).filter(
          (b) => b.status === "CONFIRMED"
        );
        const months = Array.from({ length: 12 }, (_, i) => ({
          month: i + 1,
          map: new Map(),
        }));
        for (const b of confirmed) {
          const dt = b.updatedAt // Confirmation date is updatedAt on server
            ? new Date(b.updatedAt)
            : b.createdAt
            ? new Date(b.createdAt)
            : null;
          if (!dt) continue;
          const y = dt.getFullYear();
          if (y !== Number(year)) continue;
          const m = dt.getMonth() + 1;
          const currency = b.pricing?.currency || "NU";
          const cents = b.pricing?.totalGroupCents || 0;
          const rec = months[m - 1];
          const prev = rec.map.get(currency) || 0;
          rec.map.set(currency, prev + cents);
        }
        return months.map((rec) => {
          const byCurrency = Array.from(rec.map.entries()).map(
            ([currency, totalCents]) => ({ currency, totalCents })
          );
          const overallCents = byCurrency.reduce((s, r) => s + r.totalCents, 0);
          return { month: rec.month, byCurrency, overallCents };
        });
      }

      function updateRevenueCardForSelection() {
        const year = Number(revYearEl.value);
        const month = Number(revMonthEl.value);
        const data = monthlyRevenueCache[year] || [];
        const row = data.find((r) => r.month === month) || {
          byCurrency: [],
          overallCents: 0,
        };

        if ((row.byCurrency || []).length <= 1) {
          const r = row.byCurrency[0] || { currency: "NU", totalCents: 0 };
          totalRevenueEl.textContent = centsToCurrencyString(
            r.totalCents,
            r.currency
          );
          revenueBreakdownEl.textContent = `${monthName(month)} ${year}`;
        } else {
          totalRevenueEl.textContent = centsToCurrencyString(
            row.overallCents,
            "NU"
          );
          const top = row.byCurrency
            .slice()
            .sort((a, b) => (b.totalCents || 0) - (a.totalCents || 0))
            .slice(0, 3)
            .map(
              (r) =>
                `${r.currency}: ${centsToCurrencyString(
                  r.totalCents,
                  r.currency
                )}`
            )
            .join(" • ");
          revenueBreakdownEl.textContent = `${monthName(
            month
          )} ${year} • ${top}${row.byCurrency.length > 3 ? " • …" : ""}`;
        }
      }

      function monthName(m) {
        return (
          [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ][m - 1] || String(m)
        );
      }

      /* -------------------- CHARTS -------------------- */
      function getChartCtx(id) {
        const el = document.getElementById(id);
        return el ? el.getContext("2d") : null;
      }
      function destroyChart(id) {
        if (chartInstances[id]) {
          chartInstances[id].destroy();
          delete chartInstances[id];
        }
      }

      function drawRevenueByMonthChart() {
        const ctxId = "revenueByMonthChart";
        const ctx = document.getElementById(ctxId);
        if (!ctx) return;

        const year = Number(revYearEl.value);
        const months =
          monthlyRevenueCache[year] ||
          Array.from({ length: 12 }, (_, i) => ({
            month: i + 1,
            overallCents: 0,
          }));
        const labels = months.map((m) => monthName(m.month));
        const data = months.map((m) => (m.overallCents || 0) / 100);

        if (chartInstances[ctxId]) chartInstances[ctxId].destroy();
        chartInstances[ctxId] = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: `Revenue (${year})`,
                data,
                backgroundColor: "rgba(26, 115, 232, 0.8)",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                ticks: { callback: (v) => `NU ${Number(v).toLocaleString()}` },
              },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      function aggregateBookingsByMonth(year, rows) {
        const months = Array.from({ length: 12 }, (_, i) => ({
          month: i + 1,
          all: 0,
          confirmed: 0,
        }));
        for (const b of rows || []) {
          const dt = b.createdAt ? new Date(b.createdAt) : null;
          if (!dt) continue;
          const y = dt.getFullYear();
          if (y !== Number(year)) continue;
          const m = dt.getMonth() + 1;
          months[m - 1].all += 1;
          if (b.status === "CONFIRMED") months[m - 1].confirmed += 1;
        }
        return months;
      }

      function drawBookingTrendChart() {
        const year = Number(revYearEl?.value) || new Date().getFullYear();
        const dataByMonth = aggregateBookingsByMonth(year, bookings);
        const labels = dataByMonth.map((r) => monthName(r.month));
        const allData = dataByMonth.map((r) => r.all);
        const confData = dataByMonth.map((r) => r.confirmed);

        const id = "bookingChart";
        const ctx = getChartCtx(id);
        if (!ctx) return;
        destroyChart(id);

        chartInstances[id] = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: `All Bookings (${year})`,
                data: allData,
                tension: 0.3,
                borderColor: "#ffc107",
                backgroundColor: "#ffc107",
              },
              {
                label: `Confirmed (${year})`,
                data: confData,
                tension: 0.3,
                borderColor: "#28a745",
                backgroundColor: "#28a745",
              },
            ],
          },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            stacked: false,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
          },
        });
      }

      function aggregatePackagePopularity(year, rows) {
        const map = new Map();
        for (const b of rows || []) {
          if (b.status !== "CONFIRMED") continue;
          const dt = b.updatedAt // Confirmation date
            ? new Date(b.updatedAt)
            : b.createdAt
            ? new Date(b.createdAt)
            : null;
          if (!dt || dt.getFullYear() !== Number(year)) continue;
          const title = b.packageTitleSnapshot || "Untitled Package";
          map.set(title, (map.get(title) || 0) + 1);
        }
        return Array.from(map.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
      }

      function drawPackagePopularityChart() {
        const year = Number(revYearEl?.value) || new Date().getFullYear();
        const top = aggregatePackagePopularity(year, bookings);
        const labels = top.map(([title]) => title);
        const values = top.map(([, count]) => count);

        const id = "packageChart";
        const ctx = getChartCtx(id);
        if (!ctx) return;
        destroyChart(id);

        chartInstances[id] = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: `Top Packages by Confirmed Bookings (${year})`,
                data: values,
                backgroundColor: "rgba(220, 53, 69, 0.8)",
              },
            ],
          },
          options: {
            responsive: true,
            indexAxis: labels.length > 6 ? "y" : "x",
            scales: {
              x: { ticks: { precision: 0 } },
              y: { beginAtZero: true, ticks: { precision: 0 } },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) =>
                    ` ${ctx.parsed} booking${ctx.parsed === 1 ? "" : "s"}`,
                },
              },
            },
          },
        });
      }

      function initCharts() {
        drawRevenueByMonthChart();
        drawBookingTrendChart();
        drawPackagePopularityChart();
      }

      /* -------------------- NOTIFICATIONS UI -------------------- */
      function setupNotificationUI() {
        notificationToggle.addEventListener("click", (e) => {
          const expanded = notificationPanel.classList.toggle("active");
          notificationToggle.setAttribute(
            "aria-expanded",
            expanded ? "true" : "false"
          );
          e.stopPropagation();
        });

        document.addEventListener("click", (e) => {
          const isInside = notificationToggle.contains(e.target);
          if (!isInside) {
            notificationPanel.classList.remove("active");
            notificationToggle.setAttribute("aria-expanded", "false");
          }
        });

        clearNotificationsBtn.addEventListener("click", () => {
          notificationList
            .querySelectorAll(".notification-item.unread")
            .forEach((el) => el.classList.remove("unread"));
          notificationPanel.classList.remove("active");
          notificationToggle.setAttribute("aria-expanded", "false");
        });

        viewAllNotificationsBtn.addEventListener("click", () => {
          notificationPanel.classList.remove("active");
          navigateToSection("bookings");
        });
      }

      function updateNotificationsUI() {
        const pending = (bookings || []).filter((b) => b.status === "PENDING");

        if (pending.length > 0) {
          notificationBadge.style.display = "flex";
          notificationBadge.textContent = String(pending.length);
        } else {
          notificationBadge.style.display = "none";
          notificationBadge.textContent = "0";
        }

        notificationList.innerHTML = "";
        if (pending.length === 0) {
          notificationList.innerHTML = `<div style="padding: 16px; color: var(--text-light); text-align: center;">No pending bookings 🎉</div>`;
          return;
        }

        pending
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 20)
          .forEach((b) => {
            const li = document.createElement("div");
            li.className = "notification-item unread";
            li.innerHTML = `
              <div class="notification-icon"><i class="fas fa-calendar-check"></i></div>
              <div class="notification-content">
                <div class="notification-title">Pending Booking</div>
                <div class="notification-message">
                  ${escapeHtml(
                    fullName(b.customer)
                  )} requested <strong>${escapeHtml(
              b.packageTitleSnapshot || "Package"
            )}</strong> (${escapeHtml(
              formatDate(b.trip?.travelDate || b.date)
            )})
                </div>
                <div class="notification-time"><i class="far fa-clock"></i> ${timeSince(
                  b.createdAt
                )}</div>
                <div style="margin-top:8px; display:flex; gap:8px;">
                  <button class="btn btn-sm" data-booking-id="${
                    b._id
                  }" onclick="openBookingDetailModal('${b._id}')">View</button>
                  <button class="btn btn-sm btn-success" onclick="updateBookingStatusViaServer('${
                    b._id
                  }','CONFIRMED')">Confirm</button>
                  <button class="btn btn-sm btn-danger" onclick="updateBookingStatusViaServer('${
                    b._id
                  }','REJECTED')">Reject</button>
                </div>
              </div>
            `;
            notificationList.appendChild(li);
          });
      }

      /* -------------------- IMAGE HANDLING -------------------- */
      function setupImageUploads() {
        if (!packageImagePreview || !packageImageInput) return;
        packageImagePreview.addEventListener("click", () =>
          packageImageInput.click()
        );
        packageImageInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
              packageImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(this.files[0]);
          }
        });

        // Event image upload setup
        if (!eventImagePreview || !eventImageInput) return;
        eventImagePreview.addEventListener("click", () =>
          eventImageInput.click()
        );
        eventImageInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
              eventImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }

      async function uploadImageToCloudinary(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        try {
          const res = await fetch(CLOUDINARY_UPLOAD_URL, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) throw new Error("Cloudinary upload failed.");
          const data = await res.json();
          return data.secure_url;
        } catch (err) {
          console.error("Image Upload Error:", err);
          return null;
        }
      }

      /* -------------------- API: PACKAGES -------------------- */
      async function fetchAndRenderPackages() {
        try {
          const res = await fetch(`${API_BASE_URL}/packages`);
          packages = await res.json();
          renderPackages();
        } catch {
          showToast("Error loading packages.", true);
        }
      }

      /* -------------------- API: BOOKINGS -------------------- */
      async function fetchAndRenderBookings() {
        try {
          const res = await fetch(`${API_BASE_URL}/bookings`, {
            headers: getAuthHeaders(),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "Failed to fetch bookings");
          }
          bookings = await res.json();
          renderAllBookings();
          renderRecentBookings();
          updateNotificationsUI();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function refreshAllData() {
        await Promise.all([
          fetchAndRenderPackages(),
          fetchAndRenderBookings(),
          fetchAndRenderEvents(),
          fetchAndRenderGallery(),
          fetchAndRenderTestimonials(),
          fetchAndRenderFaqs(), // NEW
        ]);
        await updateStatsFromServer();

        const year = Number(revYearEl.value);
        delete monthlyRevenueCache[year];
        await hydrateRevenueYear(year);

        updateRevenueCardForSelection();
        drawRevenueByMonthChart();
        drawBookingTrendChart();
        drawPackagePopularityChart();
      }

      // Confirm/Reject via server endpoints
      async function updateBookingStatusViaServer(bookingId, status) {
        try {
          let reason = "";
          if (status === "REJECTED")
            reason = prompt("Add a reason for rejection (optional):") || "";

          const endpoint = status === "CONFIRMED" ? "confirm" : "reject";
          const res = await fetch(
            `${API_BASE_URL}/bookings/${bookingId}/${endpoint}`,
            {
              method: "PATCH",
              headers: getAuthHeaders(),
              body: JSON.stringify(reason ? { reason } : {}),
            }
          );

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(
              err.error || `Failed to ${status.toLowerCase()} booking`
            );
          }

          showToast(`Booking ${status.toLowerCase()} successfully!`);
          closeModal(document.getElementById("booking-detail-modal"));
          await refreshAllData();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handlePackageFormSubmit() {
        let imageUrl = document.getElementById(
          "package-image-url-hidden"
        ).value;
        const file = packageImageInput?.files?.[0];

        packageFormSubmitBtn.disabled = true;
        packageFormSubmitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Saving...';

        if (file) {
          packageFormSubmitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Uploading Image...';
          imageUrl = await uploadImageToCloudinary(file);
          if (!imageUrl) {
            showToast("Image upload failed. Please try again.", true);
            packageFormSubmitBtn.disabled = false;
            packageFormSubmitBtn.textContent = "Save Package";
            return;
          }
        }

        if (!imageUrl) {
          showToast("Please select an image for the package.", true);
          packageFormSubmitBtn.disabled = false;
          packageFormSubmitBtn.textContent = "Save Package";
          return;
        }

        const slug = document.getElementById("package-slug-hidden").value;
        const isEditing = !!slug;
        const packageData = {
          title: document.getElementById("package-title").value,
          location: document.getElementById("package-location").value,
          priceNU: parseInt(
            document.getElementById("package-price-nu").value,
            10
          ),
          durationText: document.getElementById("package-duration-text").value,
          travelers: parseInt(
            document.getElementById("package-travelers").value,
            10
          ),
          type: document.getElementById("package-type").value,
          rating: parseFloat(document.getElementById("package-rating").value),
          description: document.getElementById("package-description").value,
          includes: document
            .getElementById("package-includes")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean),
          priceDetails: collectPriceDetails(
            document.getElementById("price-details-container")
          ),
          image: imageUrl,
        };

        if (packageData.priceDetails === null) {
          packageFormSubmitBtn.disabled = false;
          packageFormSubmitBtn.textContent = "Save Package";
          return;
        }

        if (!isEditing) {
          packageData.slug = packageData.title
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, "")
            .replace(/\s+/g, "-");
        }

        try {
          const url = isEditing
            ? `${API_BASE_URL}/packages/${slug}`
            : `${API_BASE_URL}/packages`;
          const method = isEditing ? "PATCH" : "POST";
          const res = await fetch(url, {
            method,
            headers: getAuthHeaders(),
            body: JSON.stringify(packageData),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "Save failed");
          }
          closeModal(document.getElementById("package-modal"));
          showToast(`Package ${isEditing ? "updated" : "added"}!`);
          await refreshAllData();
        } catch (error) {
          showToast(`Error: ${error.message}`, true);
        } finally {
          packageFormSubmitBtn.disabled = false;
          packageFormSubmitBtn.textContent = "Save Package";
        }
      }

      function confirmDeletePackage(slug) {
        currentDeleteItem = { id: slug, type: "Package" };
        deleteModalMessage.textContent =
          "Are you sure you want to delete this package? This action cannot be undone.";
        openModal("delete-confirm-modal");
      }

      // RENDER
      function renderPackages() {
        packagesGrid.innerHTML = "";
        if (!packages || packages.length === 0) {
          packagesGrid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: white; border-radius: 12px;">
              <h3 style="margin-bottom: 10px;">No packages found</h3>
              <button class="btn" id="add-first-package"><i class="fas fa-plus"></i> Add Package</button>
            </div>`;
          document
            .getElementById("add-first-package")
            .addEventListener("click", openPackageModalForCreate);
          return;
        }

        packages.forEach((pkg) => {
          const card = document.createElement("div");
          card.className = "package-card";
          card.innerHTML = `
            <div class="package-image"><img src="${pkg.image}" alt="${
            pkg.title
          }"></div>
            <div class="package-content">
                <h3 class="package-title">${pkg.title}</h3>
                <div class="package-location"><i class="fas fa-map-marker-alt"></i> ${
                  pkg.location
                }</div>
                <div class="package-price">NU ${Number(
                  pkg.priceNU || 0
                ).toLocaleString()}</div>
                <div class="package-meta">
                    <span><i class="far fa-clock"></i> ${
                      pkg.durationText
                    }</span>
                    <span><i class="fas fa-user-friends"></i> ${
                      pkg.travelers
                    } Pax</span>
                    <span><i class="fas fa-star"></i> ${pkg.rating}</span>
                </div>
                <div class="package-actions">
                    <button class="btn btn-secondary view-package-btn" data-slug="${
                      pkg.slug
                    }">View</button>
                    <button class="btn edit-package-btn" data-slug="${
                      pkg.slug
                    }">Edit</button>
                    <button class="btn btn-danger delete-package-btn" data-slug="${
                      pkg.slug
                    }">Delete</button>
                </div>
            </div>`;
          packagesGrid.appendChild(card);
        });
      }

      function renderAllBookings() {
        allBookingsBody.innerHTML = "";
        if (!bookings || bookings.length === 0) {
          allBookingsBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 40px;">No bookings found.</td></tr>`;
          return;
        }

        bookings.forEach((booking) => {
          const row = document.createElement("tr");
          const customerName =
            `${booking.customer?.firstName || ""} ${
              booking.customer?.lastName || ""
            }`.trim() ||
            booking.customerName ||
            "N/A";
          const customerContact = `
            <div>${booking.customer?.email || booking.customerEmail || ""}</div>
            <div style="color: #757575; font-size: 12px;">${
              booking.customer?.phone || booking.customerPhone || ""
            }</div>`;
          const statusClass = booking.status.toLowerCase();

          row.innerHTML = `
            <td>${booking._id.slice(-8)}</td>
            <td>${customerName}</td>
            <td>${customerContact}</td>
            <td>${booking.packageTitleSnapshot}</td>
            <td>${formatDate(booking.trip?.travelDate || booking.date)}</td>
            <td>${formatCurrency(
              booking.pricing?.totalGroupCents,
              booking.pricing?.currency
            )}</td>
            <td><span class="status ${statusClass}">${
            booking.status
          }</span></td>
            <td>
              <button class="action-btn view-booking-btn" title="View Details" data-booking-id="${
                booking._id
              }">
                <i class="fas fa-eye"></i>
              </button>
            </td>`;
          allBookingsBody.appendChild(row);
        });
      }

      function renderRecentBookings() {
        recentBookingsBody.innerHTML = "";
        const recent = bookings
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 5);

        if (recent.length === 0) {
          recentBookingsBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">No recent bookings.</td></tr>`;
          return;
        }

        recent.forEach((booking) => {
          const row = document.createElement("tr");
          const customerName =
            `${booking.customer?.firstName || ""} ${
              booking.customer?.lastName || ""
            }`.trim() ||
            booking.customerName ||
            "N/A";
          const statusClass = booking.status.toLowerCase();

          row.innerHTML = `
            <td>${booking._id.slice(-8)}</td>
            <td>${customerName}</td>
            <td>${booking.packageTitleSnapshot}</td>
            <td>${formatDate(booking.trip?.travelDate || booking.date)}</td>
            <td>${formatCurrency(
              booking.pricing?.totalGroupCents,
              booking.pricing?.currency
            )}</td>
            <td><span class="status ${statusClass}">${
            booking.status
          }</span></td>
            <td>
              <button class="action-btn view-booking-btn" title="View Details" data-booking-id="${
                booking._id
              }">
                <i class="fas fa-eye"></i>
              </button>
            </td>`;
          recentBookingsBody.appendChild(row);
        });
      }

      // Helpers
      function formatDate(dateString) {
        if (!dateString) return "N/A";
        return new Date(dateString).toLocaleDateString("en-CA");
      }
      function formatCurrency(cents, currency = "NU") {
        if (cents === null || cents === undefined) return "N/A";
        const amount = cents / 100;
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: currency === "NU" ? "BTN" : currency,
          minimumFractionDigits: 2,
        })
          .format(amount)
          .replace("BTN", currency);
      }
      function fullName(customer = {}) {
        const fn = (customer.firstName || "").trim();
        const ln = (customer.lastName || "").trim();
        const name = `${fn} ${ln}`.trim();
        return name || "Customer";
      }
      function escapeHtml(str = "") {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      function timeSince(date) {
        const d = new Date(date);
        const seconds = Math.floor((Date.now() - d.getTime()) / 1000);
        const intervals = [
          { label: "y", secs: 31536000 },
          { label: "mo", secs: 2592000 },
          { label: "d", secs: 86400 },
          { label: "h", secs: 3600 },
          { label: "m", secs: 60 },
          { label: "s", secs: 1 },
        ];
        for (const { label, secs } of intervals) {
          const v = Math.floor(seconds / secs);
          if (v >= 1) return `${v}${label} ago`;
        }
        return "just now";
      }

      function navigateToSection(sectionId) {
        navItems.forEach((item) =>
          item.classList.toggle("active", item.dataset.section === sectionId)
        );
        contentSections.forEach((section) =>
          section.classList.toggle(
            "active",
            section.id === `${sectionId}-section`
          )
        );
        document.querySelector(".top-bar-left h2").textContent = {
          dashboard: "Dashboard Overview",
          packages: "Tour Packages Management",
          bookings: "Bookings Management",
          events: "Events Management",
          testimonials: "Testimonials Management",
          faq: "FAQ Management", // NEW
          gallery: "Gallery Management",
          reports: "Reports & Analytics",
        }[sectionId];
      }

      function openModal(id) {
        document.getElementById(id).style.display = "flex";
      }
      function closeModal(modal) {
        if (modal) modal.style.display = "none";
      }

      // --- CREATE / EDIT PACKAGE MODAL HELPERS ---
      function openPackageModalForCreate() {
        if (!packageForm) return;
        packageForm.reset();
        document.getElementById("package-modal-title").textContent =
          "Add New Tour Package";
        document.getElementById("package-slug-hidden").value = "";
        document.getElementById("package-image-url-hidden").value = "";
        packageImagePreview.innerHTML = `
        <div class="image-upload-placeholder">
          <i class="fas fa-image"></i>
          <p>Click to upload package image</p>
        </div>`;
        packageFormSubmitBtn.textContent = "Save Package";
        renderPriceDetails(document.getElementById("price-details-container"), [
          {},
        ]);
        openModal("package-modal");
      }

      function openPackageModalForEdit(slug) {
        const pkg = packages.find((p) => p.slug === slug);
        if (!pkg) {
          showToast("Could not find package to edit.", true);
          return;
        }
        packageForm.reset();
        document.getElementById("package-modal-title").textContent =
          "Edit Tour Package";
        document.getElementById("package-slug-hidden").value = pkg.slug;
        document.getElementById("package-image-url-hidden").value = pkg.image;
        document.getElementById("package-title").value = pkg.title;
        document.getElementById("package-location").value = pkg.location;
        document.getElementById("package-price-nu").value = pkg.priceNU;
        document.getElementById("package-duration-text").value =
          pkg.durationText;
        document.getElementById("package-travelers").value = pkg.travelers;
        document.getElementById("package-type").value = pkg.type;
        document.getElementById("package-rating").value = pkg.rating;
        document.getElementById("package-description").value = pkg.description;
        document.getElementById("package-includes").value = (
          pkg.includes || []
        ).join(", ");
        packageImagePreview.innerHTML = `<img src="${pkg.image}" alt="Package Image">`;
        renderPriceDetails(
          document.getElementById("price-details-container"),
          pkg.priceDetails
        );
        packageFormSubmitBtn.textContent = "Update Package";
        openModal("package-modal");
      }

      function viewPackage(slug) {
        const pkg = packages.find((p) => p.slug === slug);
        if (!pkg) return;
        const content = document.getElementById("view-package-content");
        content.innerHTML = `
            <div style="padding: 10px;">
                <img src="${pkg.image}" alt="${pkg.title}" style="width: 100%; border-radius: 8px; margin-bottom: 16px;">
                <h2 style="font-size: 24px; margin-bottom: 8px;">${pkg.title}</h2>
                <p style="color: var(--text-light); margin-bottom: 16px;"><i class="fas fa-map-marker-alt"></i> ${pkg.location}</p>
                <div style="font-size: 16px; line-height: 1.6;">${pkg.description}</div>
            </div>
        `;
        openModal("view-package-modal");
      }

      function createPriceDetailRow(detail = {}) {
        const row = document.createElement("div");
        row.className = "price-detail-row";
        row.innerHTML = `
          <select class="price-package" required>
            <option value="Standard (3★)" ${
              detail.package === "Standard (3★)" ? "selected" : ""
            }>Standard (3★)</option>
          </select>
          <input type="number" class="price-days" placeholder="Days" value="${
            detail.days || ""
          }" required>
          <select class="price-group-size" required>
            <option value="Solo" ${
              detail.groupSize === "Solo" ? "selected" : ""
            }>Solo</option>
            <option value="2 pax" ${
              detail.groupSize === "2 pax" ? "selected" : ""
            }>2 pax</option>
            <option value="3+ pax" ${
              detail.groupSize === "3+ pax" ? "selected" : ""
            }>3+ pax</option>
          </select>
          <input type="number" class="price-tour-price" placeholder="Tour Price" value="${
            detail.tourPrice || ""
          }" required>
          <input type="number" class="price-sdf" placeholder="SDF" value="${
            detail.sdf || ""
          }" required>
          <input type="number" class="price-total" placeholder="Total" value="${
            detail.totalPerPerson || ""
          }" required>
          <button type="button" class="btn btn-danger btn-sm remove-price-row-btn"><i class="fas fa-trash"></i></button>`;
        return row;
      }

      function renderPriceDetails(container, details) {
        container.innerHTML = `<div class="price-details-header"><span>Package</span><span>Days</span><span>Group Size</span><span>Tour Price/day</span><span>SDF/day</span><span>Total</span><span>Action</span></div>`;
        (details?.length > 0 ? details : [{}]).forEach((detail) => {
          container.appendChild(createPriceDetailRow(detail));
        });
      }

      function collectPriceDetails(container) {
        const details = [];
        let isValid = true;
        container.querySelectorAll(".price-detail-row").forEach((row) => {
          const detail = {
            package: row.querySelector(".price-package").value,
            days: parseInt(row.querySelector(".price-days").value, 10),
            groupSize: row.querySelector(".price-group-size").value,
            tourPrice: parseInt(
              row.querySelector(".price-tour-price").value,
              10
            ),
            sdf: parseInt(row.querySelector(".price-sdf").value, 10),
            totalPerPerson: parseInt(
              row.querySelector(".price-total").value,
              10
            ),
          };
          if (
            [
              detail.days,
              detail.tourPrice,
              detail.sdf,
              detail.totalPerPerson,
            ].some((n) => isNaN(n))
          ) {
            isValid = false;
          }
          details.push(detail);
        });
        if (!isValid) {
          showToast("Please fill all numeric fields in Price Details.", true);
          return null;
        }
        return details;
      }

      function openBookingDetailModal(bookingId) {
        const booking = bookings.find((b) => b._id === bookingId);
        if (!booking) {
          showToast("Could not find booking details.", true);
          return;
        }
        document.getElementById("detail-customer-name").textContent =
          `${booking.customer?.firstName || ""} ${
            booking.customer?.lastName || ""
          }`.trim() || "N/A";
        document.getElementById("detail-customer-email").textContent =
          booking.customer?.email || "N/A";
        document.getElementById("detail-customer-phone").textContent =
          booking.customer?.phone || "N/A";
        document.getElementById("detail-package-name").textContent =
          booking.packageTitleSnapshot;
        document.getElementById("detail-travel-date").textContent = formatDate(
          booking.trip?.travelDate
        );
        document.getElementById("detail-travelers").textContent = `${
          booking.trip?.travelers ?? 0
        } Adults`;
        document.getElementById("detail-booking-id").textContent = booking._id;
        document.getElementById("detail-booking-date").textContent = formatDate(
          booking.createdAt
        );
        const statusSpan = document.getElementById("detail-booking-status");
        statusSpan.innerHTML = `<span class="status ${booking.status.toLowerCase()}">${
          booking.status
        }</span>`;
        document.getElementById("detail-total-amount").textContent =
          formatCurrency(
            booking.pricing?.totalGroupCents,
            booking.pricing?.currency
          );

        const actionsContainer = document.getElementById(
          "booking-detail-actions"
        );
        if (booking.status === "PENDING") {
          actionsContainer.innerHTML = `
            <button type="button" class="btn btn-secondary close-modal">Cancel</button>
            <button type="button" class="btn btn-danger reject-booking-btn" data-booking-id="${booking._id}">
              <i class="fas fa-times-circle"></i> Reject
            </button>
            <button type="button" class="btn btn-success confirm-booking-btn" data-booking-id="${booking._id}">
              <i class="fas fa-check-circle"></i> Confirm
            </button>`;
        } else {
          actionsContainer.innerHTML = `<button type="button" class="btn btn-secondary close-modal">Close</button>`;
        }
        openModal("booking-detail-modal");
      }

      function showToast(message, isError = false) {
        toastMessage.textContent = message;
        toast.className = `toast ${isError ? "error" : ""} show`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function setupEventListeners() {
        navItems.forEach((item) =>
          item.addEventListener("click", () =>
            navigateToSection(item.dataset.section)
          )
        );
        closeModalButtons.forEach((button) =>
          button.addEventListener("click", () =>
            closeModal(button.closest(".modal-backdrop"))
          )
        );
        modals.forEach((modal) =>
          modal.addEventListener("click", (e) => {
            if (e.target === modal) closeModal(modal);
          })
        );
        if (addPackageBtn)
          addPackageBtn.addEventListener("click", openPackageModalForCreate);
        if (packageForm)
          packageForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handlePackageFormSubmit();
          });

        // Testimonial event listeners
        if (addTestimonialBtn) {
          addTestimonialBtn.addEventListener(
            "click",
            openTestimonialModalForCreate
          );
        }
        if (testimonialForm) {
          testimonialForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handleTestimonialFormSubmit();
          });
        }

        // NEW: FAQ event listeners
        if (addFaqBtn) {
          addFaqBtn.addEventListener("click", openFaqModalForCreate);
        }
        if (faqForm) {
          faqForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handleFaqFormSubmit();
          });
        }

        // Event listeners
        if (addEventBtn)
          addEventBtn.addEventListener("click", openEventModalForCreate);
        if (eventForm)
          eventForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handleEventFormSubmit();
          });

        // Profile Dropdown and Modal Listeners
        if (profileMenuTrigger) {
          profileMenuTrigger.addEventListener("click", (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle("active");
          });
        }
        // MODIFIED: This now calls the new backend-connected function
        if (profileForm) {
          profileForm.addEventListener("submit", handleProfileFormSubmit);
        }
        document.addEventListener("click", (e) => {
          if (
            profileDropdown &&
            profileMenuTrigger &&
            !profileMenuTrigger.contains(e.target) &&
            !profileDropdown.contains(e.target)
          ) {
            profileDropdown.classList.remove("active");
          }
        });

        if (confirmDeleteBtn) {
          confirmDeleteBtn.addEventListener("click", handleConfirmDelete);
        }

        // Delegated clicks
        document.body.addEventListener("click", async (e) => {
          const button = e.target.closest("button, .profile-dropdown-item");
          if (!button) return;

          // Profile Dropdown Actions
          if (button.id === "edit-profile-btn") {
            openProfileModal(); // MODIFIED: This now populates from fetched data
            profileDropdown.classList.remove("active");
            return;
          }
          if (button.id === "logout-btn") {
            logout(); // MODIFIED: This now communicates with the backend
            return;
          }

          // Price rows
          if (button.classList.contains("add-price-row-btn")) {
            document
              .getElementById("price-details-container")
              .appendChild(createPriceDetailRow());
            return;
          }
          if (button.classList.contains("remove-price-row-btn")) {
            button.closest(".price-detail-row").remove();
            return;
          }

          // Package actions
          const packageSlug = button
            .closest(".package-actions")
            ?.querySelector("[data-slug]")?.dataset.slug;
          if (packageSlug) {
            if (button.classList.contains("view-package-btn"))
              viewPackage(packageSlug);
            if (button.classList.contains("edit-package-btn"))
              openPackageModalForEdit(packageSlug);
            if (button.classList.contains("delete-package-btn"))
              confirmDeletePackage(packageSlug);
            return;
          }

          // Event actions
          const eventId = button
            .closest(".event-actions")
            ?.querySelector("[data-event-id]")?.dataset.eventId;
          if (eventId) {
            if (button.classList.contains("edit-event-btn"))
              openEventModalForEdit(eventId);
            if (button.classList.contains("delete-event-btn"))
              deleteEvent(eventId);
            return;
          }

          // Testimonial actions
          const testimonialId = button
            .closest("td")
            ?.querySelector("[data-testimonial-id]")?.dataset.testimonialId;
          if (testimonialId) {
            if (button.classList.contains("edit-testimonial-btn"))
              openTestimonialModalForEdit(testimonialId);
            if (button.classList.contains("delete-testimonial-btn"))
              deleteTestimonial(testimonialId);
            return;
          }

          // NEW: FAQ actions
          const faqId = button.closest("td")?.querySelector("[data-faq-id]")
            ?.dataset.faqId;
          if (faqId) {
            if (button.classList.contains("edit-faq-btn"))
              openFaqModalForEdit(faqId);
            if (button.classList.contains("delete-faq-btn")) deleteFaq(faqId);
            return;
          }

          // Booking actions
          if (button.dataset.bookingId) {
            const bookingId = button.dataset.bookingId;
            if (button.classList.contains("view-booking-btn")) {
              openBookingDetailModal(bookingId);
              return;
            }
            if (button.classList.contains("confirm-booking-btn")) {
              updateBookingStatusViaServer(bookingId, "CONFIRMED");
              return;
            }
            if (button.classList.contains("reject-booking-btn")) {
              updateBookingStatusViaServer(bookingId, "REJECTED");
              return;
            }
          }

          // Gallery actions
          if (button.classList.contains("delete-gallery-image")) {
            const index = parseInt(button.dataset.index);
            deleteGalleryImage(index);
            return;
          }

          // NEW: Gallery preview remove button
          if (button.classList.contains("remove-gallery-preview-btn")) {
            const index = parseInt(button.dataset.index, 10);
            if (!isNaN(index)) {
              galleryFilesToUpload.splice(index, 1);
              renderGalleryUploadPreviews(); // Re-render previews
            }
            return;
          }
        });
      }

      document.addEventListener("DOMContentLoaded", initDashboard);
      // Expose functions for inline onclick in notification panel
      window.openBookingDetailModal = openBookingDetailModal;
      window.updateBookingStatusViaServer = updateBookingStatusViaServer;
    </script>
  </body>
</html>
